name: Simple Security Scan Test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run basic security checks
      run: |
        echo "Running simplified security checks..."
        
        # 创建模拟结果文件
        echo "### Security Scan Results" > scan-result.md
        echo "- Found 0 critical vulnerabilities" >> scan-result.md
        echo "- Found 2 high vulnerabilities" >> scan-result.md
        echo "- Found 5 medium vulnerabilities" >> scan-result.md
        
        echo "TRUE" > result.txt
        
        # 创建摘要文件
        echo "## Scan Summary" > summary-min.md
        echo "🟢 No critical vulnerabilities found" >> summary-min.md
        echo "🔴 2 high vulnerabilities need review" >> summary-min.md
        
        echo "Checks completed"
        
    - name: Upload scan results
      uses: actions/upload-artifact@v3
      with:
        name: scan-results-artifact
        path: |
          scan-result.md
          summary-min.md
          result.txt
        
    - name: Display PR summary
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const summary = `### Security Scan Results
          ✅ No critical vulnerabilities found
          ⚠️ 2 high vulnerabilities need review
          [View full report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          })
    
    - name: Display workflow summary
      run: |
        echo "### Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "🟢 No critical vulnerabilities found" >> $GITHUB_STEP_SUMMARY
        echo "🔴 2 high vulnerabilities need review" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Scan completed at $(date)" >> $GITHUB_STEP_SUMMARY

    - name: Check scan results
      run: |
        RESULT=$(cat result.txt)
        if [ "$RESULT" = "TRUE" ]; then
          echo "Security gate passed"
        else
          echo "Security gate failed"
          exit 1
        fi
